<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡Ÿé¤Šç´ è£œå……æœ€ä½³åŒ–å·¥å…·</title>
    
    <!-- Google Analytics -->
    <!-- å°‡ä½ çš„ Google Analytics ä»£ç¢¼è²¼åœ¨é€™è£¡ -->
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DNW6BEKZW2"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-DNW6BEKZW2');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2em;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .section h2 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }
        
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.secondary:hover {
            background: #5a6268;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        button.danger:hover {
            background: #c82333;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .requirement-item,
        .product-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        
        .requirement-item h4,
        .product-item h4 {
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .product-item {
            position: relative;
        }
        
        .product-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .analysis-result {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .status-box {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .status-box.success {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        
        .status-box.warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        
        .status-box.danger {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }
        
        .status-box h3 {
            margin-bottom: 10px;
        }
        
        .nutrient-list {
            list-style: none;
        }
        
        .nutrient-list li {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.5);
            border-radius: 5px;
        }
        
        .solutions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .solutions-table th,
        .solutions-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .solutions-table th {
            background: #667eea;
            color: white;
            font-weight: 500;
        }
        
        .solutions-table tr:hover {
            background: #f8f9fa;
        }
        
        .cost-highlight {
            font-size: 1.5em;
            color: #667eea;
            font-weight: bold;
        }
        
        .completeness-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .completeness-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .flex-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .nutrient-input-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        
        .product-nutrient-row {
            display: grid;
            grid-template-columns: 2fr 1fr 80px auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        
        #currentAnalysis {
            position: sticky;
            top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ¿ ç‡Ÿé¤Šç´ è£œå……æœ€ä½³åŒ–å·¥å…·</h1>
        
        <!-- å·¥å…·èªªæ˜ -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
            <h3 style="margin: 0 0 10px 0; color: white;">ğŸ’¡ é€™å€‹å·¥å…·å¯ä»¥å¹«ä½ åšä»€éº¼ï¼Ÿ</h3>
            <p style="margin: 5px 0; line-height: 1.6;">
                ğŸ“Š <strong>æ¯”è¼ƒä¸åŒä¿å¥é£Ÿå“çµ„åˆ</strong>ï¼Œæ‰¾å‡ºæœ€ç¬¦åˆéœ€æ±‚ã€æˆæœ¬æœ€ä½çš„è³¼è²·æ–¹æ¡ˆ<br>
                ğŸ’° <strong>è‡ªå‹•è¨ˆç®—æ¯æ—¥æˆæœ¬</strong>ï¼Œå‘Šè¨´ä½ æ¯å¤©è¦åƒå¹¾é¡†æ‰èƒ½æ»¿è¶³ç‡Ÿé¤Šéœ€æ±‚<br>
                âš–ï¸ <strong>åˆ†æç‡Ÿé¤Šç´ ç¼ºå£</strong>ï¼Œæ¸…æ¥šé¡¯ç¤ºå“ªäº›ç‡Ÿé¤Šç´ ä¸è¶³ã€å“ªäº›éé‡
            </p>
        </div>
        
        <!-- é‡è¦æç¤º -->
        <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
            <h3 style="margin: 0 0 10px 0; color: #856404;">âš ï¸ ä½¿ç”¨å‰å¿…è®€</h3>
            <ul style="margin: 5px 0; padding-left: 20px; color: #856404; line-height: 1.8;">
                <li><strong>è³‡æ–™ä¿å­˜ï¼š</strong>æŒ‰ä¸‹ã€ŒğŸ’¾ å„²å­˜éœ€æ±‚ã€æˆ–ã€ŒğŸ’¾ æ–°å¢ç”¢å“ã€å¾Œï¼Œè³‡æ–™æœƒè‡ªå‹•å­˜åœ¨<strong>æ‚¨çš„ç€è¦½å™¨</strong>ä¸­ã€‚å°±ç®—é—œé–‰ç¶²é é‡æ–°é–‹å•Ÿï¼Œè³‡æ–™é‚„æœƒåœ¨ï¼</li>
                <li><strong>æ³¨æ„å–®ä½ï¼š</strong>å¡«å¯«ç‡Ÿé¤Šç´ å«é‡æ™‚ï¼Œè«‹ç‰¹åˆ¥æ³¨æ„å–®ä½æ˜¯ <strong>mgï¼ˆæ¯«å…‹ï¼‰</strong>é‚„æ˜¯ <strong>Î¼gï¼ˆå¾®å…‹ï¼‰</strong>ï¼Œ1 mg = 1000 Î¼g</li>
                <li><strong>è·¨è£ç½®ä½¿ç”¨ï¼š</strong>æƒ³åœ¨æ‰‹æ©Ÿå’Œé›»è…¦éƒ½ä½¿ç”¨ï¼Ÿé»æ“Šä¸‹æ–¹ã€ŒğŸ“¥ åŒ¯å‡ºè³‡æ–™ã€å‚™ä»½ï¼Œå†åˆ°å¦ä¸€å€‹è£ç½®ã€ŒğŸ“¤ åŒ¯å…¥è³‡æ–™ã€å³å¯</li>
                <li><strong>å»ºè­°å®šæœŸå‚™ä»½ï¼š</strong>æ¸…é™¤ç€è¦½å™¨è³‡æ–™æœƒè®“æ‚¨çš„è¨­å®šæ¶ˆå¤±ï¼Œå»ºè­°å®šæœŸåŒ¯å‡ºå‚™ä»½ä»¥é˜²è¬ä¸€</li>
            </ul>
        </div>
        
        <!-- è³‡æ–™ç®¡ç†åŠŸèƒ½ -->
        <div style="background: #e7f3ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
            <h3 style="margin: 0 0 10px 0; color: #004085;">ğŸ—‚ï¸ è³‡æ–™ç®¡ç†</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="exportData()" style="background: #28a745; padding: 10px 20px; display: flex; align-items: center; gap: 5px;">
                    ğŸ“¥ åŒ¯å‡ºè³‡æ–™
                    <small style="opacity: 0.8;">(å‚™ä»½)</small>
                </button>
                <button onclick="document.getElementById('importFile').click()" style="background: #17a2b8; padding: 10px 20px; display: flex; align-items: center; gap: 5px;">
                    ğŸ“¤ åŒ¯å…¥è³‡æ–™
                    <small style="opacity: 0.8;">(é‚„åŸ)</small>
                </button>
                <button onclick="clearAllData()" style="background: #dc3545; padding: 10px 20px; display: flex; align-items: center; gap: 5px;">
                    ğŸ—‘ï¸ æ¸…ç©ºè³‡æ–™
                    <small style="opacity: 0.8;">(é‡æ–°é–‹å§‹)</small>
                </button>
                <button onclick="showUnitGuide()" style="background: #6c757d; padding: 10px 20px; display: flex; align-items: center; gap: 5px;">
                    ğŸ“– å–®ä½å°ç…§è¡¨
                </button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
        </div>
        
        <!-- æ­¥é©Ÿ1: è¨­å®šç‡Ÿé¤Šç´ éœ€æ±‚ -->
        <div class="section">
            <h2>æ­¥é©Ÿ 1ï¼šè¨­å®šç‡Ÿé¤Šç´ éœ€æ±‚ç¯„åœ</h2>
            <p style="color: #6c757d; margin-bottom: 15px;">
                ğŸ’¡ <strong>å¡«å¯«æç¤ºï¼š</strong>è¼¸å…¥æ‚¨æ¯æ—¥æ‰€éœ€çš„ç‡Ÿé¤Šç´ åç¨±å’Œæ”å–ç¯„åœã€‚ä¾‹å¦‚ï¼šç¶­ä»–å‘½B6 æœ€å° 10 mgã€æœ€å¤§ 50 mgã€‚
                <strong style="color: #dc3545;">ç‰¹åˆ¥æ³¨æ„å–®ä½</strong>ï¼šç¶­ä»–å‘½ Dã€B12 é€šå¸¸ç”¨ã€Œå¾®å…‹(Î¼g)ã€ï¼Œå…¶ä»–å¤šç”¨ã€Œæ¯«å…‹(mg)ã€ã€‚
            </p>
            <div id="requirementsInputs"></div>
            <button onclick="addRequirementInput()">â• æ–°å¢ç‡Ÿé¤Šç´ </button>
            <button onclick="saveRequirements()" style="margin-left: 10px;">ğŸ’¾ å„²å­˜éœ€æ±‚</button>
            <button onclick="clearRequirementForm()" class="secondary" style="margin-left: 10px;">ğŸ”„ æ¸…ç©ºè¡¨å–®</button>
            
            <div id="requirementsList" style="margin-top: 20px;"></div>
        </div>
        
        <!-- æ­¥é©Ÿ2: æ–°å¢ç”¢å“ -->
        <div class="section">
            <h2>æ­¥é©Ÿ 2ï¼šæ–°å¢ä¿å¥é£Ÿå“</h2>
            <p style="color: #6c757d; margin-bottom: 15px;">
                ğŸ’¡ <strong>å¡«å¯«æç¤ºï¼š</strong>è¼¸å…¥ç”¢å“çš„ç¸½åƒ¹ã€ç¸½é¡†æ•¸ï¼Œä»¥åŠ<strong>æ¯ä¸€é¡†</strong>çš„ç‡Ÿé¤Šç´ å«é‡ï¼ˆä¸æ˜¯æ¯æ—¥ç¸½é‡ï¼‰ã€‚
                ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—æ¯é¡†æˆæœ¬ï¼Œä¸¦åœ¨æ­¥é©Ÿ3å»ºè­°æ‚¨æ¯å¤©è¦åƒå¹¾é¡†ã€‚<br>
                <span style="color: #28a745;">âœ¨ å¯ä»¥è‡ªç”±è¼¸å…¥ä»»ä½•ç‡Ÿé¤Šç´ ï¼Œä¸é™æ–¼æ­¥é©Ÿ1è¨­å®šçš„é …ç›®ã€‚ç”¢å“é¡å¤–åŒ…å«çš„ç‡Ÿé¤Šç´ æœƒåœ¨æ–¹æ¡ˆæ¯”è¼ƒæ™‚ä¸€ä½µé¡¯ç¤ºã€‚</span>
            </p>
            <div class="form-group">
                <label>ç”¢å“åç¨±</label>
                <input type="text" id="productName" placeholder="ä¾‹å¦‚ï¼šç”²æ¬¾ç¶œåˆç¶­ä»–å‘½">
            </div>
            
            <div class="grid" style="grid-template-columns: 1fr 1fr;">
                <div class="form-group">
                    <label>ç¸½åƒ¹æ ¼ï¼ˆå…ƒï¼‰<span style="color: #dc3545;">*</span></label>
                    <input type="number" id="productTotalPrice" placeholder="ä¾‹å¦‚ï¼š500" step="0.01">
                </div>
                <div class="form-group">
                    <label>ç¸½é¡†æ•¸/ç¸½ä»½æ•¸<span style="color: #dc3545;">*</span></label>
                    <input type="number" id="productTotalServings" placeholder="ä¾‹å¦‚ï¼š60" step="1">
                </div>
            </div>
            
            <div style="background: #e7f3ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                <p style="margin: 0; color: #004085;">æ¯é¡†æˆæœ¬ï¼š<span id="pricePerServing" style="font-weight: bold;">NT$ 0</span></p>
            </div>
            
            <div class="form-group">
                <label>ç‡Ÿé¤Šç´ æˆåˆ†ï¼ˆæ¯é¡†/æ¯ä»½å«é‡ï¼‰</label>
                <small style="color: #6c757d; display: block; margin-bottom: 10px;">ğŸ’¡ è«‹è¼¸å…¥ã€Œæ¯ä¸€é¡†ã€çš„ç‡Ÿé¤Šç´ å«é‡ï¼Œç³»çµ±æœƒæ ¹æ“šæ‚¨çš„éœ€æ±‚è‡ªå‹•è¨ˆç®—æ¯å¤©è¦åƒå¹¾é¡†</small>
                <div id="productNutrients"></div>
                <button onclick="addProductNutrient()">â• æ–°å¢æˆåˆ†</button>
            </div>
            <button onclick="saveProduct()">ğŸ’¾ æ–°å¢ç”¢å“</button>
            <button onclick="cancelEdit()" class="secondary" style="margin-left: 10px;">ğŸ”„ æ¸…ç©ºè¡¨å–®</button>
            
            <div id="productsList" style="margin-top: 20px;"></div>
        </div>
        
        <!-- æ­¥é©Ÿ3: åˆ†æçµ„åˆ -->
        <div class="section">
            <h2>æ­¥é©Ÿ 3ï¼šé¸æ“‡ç”¢å“çµ„åˆä¸¦åˆ†æ</h2>
            <p style="color: #6c757d; margin-bottom: 15px;">
                ğŸ’¡ <strong>æ“ä½œèªªæ˜ï¼š</strong>å‹¾é¸æƒ³è¦çš„ç”¢å“ï¼Œç³»çµ±æœƒè‡ªå‹•å»ºè­°æ¯å¤©è¦åƒå¹¾é¡†ã€‚æ‚¨ä¹Ÿå¯ä»¥æ‰‹å‹•èª¿æ•´ç”¨é‡ã€‚
                åˆ†æçµæœæœƒå‘Šè¨´æ‚¨ï¼šâœ… å“ªäº›ç‡Ÿé¤Šç´ å·²æ»¿è¶³ã€âš ï¸ å“ªäº›é‚„ä¸å¤ ã€âŒ å“ªäº›éé‡ï¼Œä»¥åŠæ¯æ—¥ç¸½æˆæœ¬ã€‚
            </p>
            <div id="productsSelection"></div>
            <button onclick="analyzeSelection()" style="margin-top: 15px;">ğŸ” åˆ†æçµ„åˆ</button>
            <button onclick="saveAsSolution()" style="margin-left: 10px;">ğŸ’¾ å„²å­˜ç‚ºæ–¹æ¡ˆ</button>
            
            <div id="currentAnalysis"></div>
        </div>
        
        <!-- æ­¥é©Ÿ4: æ–¹æ¡ˆæ¯”è¼ƒ -->
        <div class="section">
            <h2>æ­¥é©Ÿ 4ï¼šæ–¹æ¡ˆæ¯”è¼ƒ</h2>
            <p style="color: #6c757d; margin-bottom: 15px;">
                ğŸ’¡ <strong>åŠŸèƒ½èªªæ˜ï¼š</strong>å°‡ä¸åŒçš„ç”¢å“çµ„åˆå„²å­˜ç‚ºæ–¹æ¡ˆï¼Œæ–¹ä¾¿æ¯”è¼ƒå“ªå€‹çµ„åˆæœ€åˆ’ç®—ã€æœ€ç¬¦åˆéœ€æ±‚ã€‚
                æ¯”è¼ƒé‡é»ï¼šæ¯æ—¥æˆæœ¬ã€å®Œæ•´åº¦ã€é‚„ç¼ºå°‘å“ªäº›ç‡Ÿé¤Šç´ ã€‚
            </p>
            <div id="solutionsList"></div>
        </div>
    </div>
    
    <script>
        let requirements = {};
        let products = {};
        let solutions = [];
        let currentAnalysisResult = null;
        let requirementInputCount = 0;
        let productNutrientCount = 0;
        let editingProductId = null;
        let editingRequirementName = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage();
            loadRequirements().then(() => {
                // ç­‰éœ€æ±‚è¼‰å…¥å®Œæˆå¾Œå†æ–°å¢ç”¢å“ç‡Ÿé¤Šç´ æ¬„ä½
                addProductNutrient();
            });
            loadProducts();
            loadSolutions();
            addRequirementInput();
            
            // ç›£è½åƒ¹æ ¼è®ŠåŒ–ä»¥æ›´æ–°æ¯é¡†æˆæœ¬
            document.getElementById('productTotalPrice').addEventListener('input', updatePricePerServing);
            document.getElementById('productTotalServings').addEventListener('input', updatePricePerServing);
        });
        
        // å¾ localStorage è¼‰å…¥æ‰€æœ‰è³‡æ–™
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('nutritionOptimizerData');
                if (saved) {
                    const data = JSON.parse(saved);
                    requirements = data.requirements || {};
                    products = data.products || {};
                    solutions = data.solutions || [];
                }
            } catch (e) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', e);
            }
        }
        
        // å„²å­˜æ‰€æœ‰è³‡æ–™åˆ° localStorage
        function saveToLocalStorage() {
            try {
                const data = {
                    requirements,
                    products,
                    solutions,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('nutritionOptimizerData', JSON.stringify(data));
            } catch (e) {
                console.error('å„²å­˜è³‡æ–™å¤±æ•—:', e);
                alert('å„²å­˜å¤±æ•—ï¼å¯èƒ½æ˜¯ç€è¦½å™¨å„²å­˜ç©ºé–“ä¸è¶³ã€‚');
            }
        }
        
        // æ›´æ–°æ¯é¡†æˆæœ¬
        function updatePricePerServing() {
            const totalPrice = parseFloat(document.getElementById('productTotalPrice').value) || 0;
            const totalServings = parseFloat(document.getElementById('productTotalServings').value) || 0;
            const pricePerServing = totalServings > 0 ? totalPrice / totalServings : 0;
            document.getElementById('pricePerServing').textContent = 'NT$ ' + pricePerServing.toFixed(2);
        }
        
        // æ–°å¢ç‡Ÿé¤Šç´ éœ€æ±‚è¼¸å…¥æ¬„ä½
        function addRequirementInput() {
            const container = document.getElementById('requirementsInputs');
            const id = requirementInputCount++;
            const div = document.createElement('div');
            div.className = 'nutrient-input-row';
            div.innerHTML = `
                <input type="text" id="req_name_${id}" placeholder="ç‡Ÿé¤Šç´ åç¨±ï¼ˆä¾‹å¦‚ï¼šç¶­ä»–å‘½B6ï¼‰">
                <input type="number" id="req_min_${id}" placeholder="æœ€å°å€¼" step="0.01">
                <input type="number" id="req_max_${id}" placeholder="æœ€å¤§å€¼" step="0.01">
                <select id="req_unit_${id}">
                    <option value="mg">æ¯«å…‹(mg)</option>
                    <option value="Î¼g">å¾®å…‹(Î¼g)</option>
                    <option value="IU">åœ‹éš›å–®ä½(IU)</option>
                    <option value="g">å…¬å…‹(g)</option>
                </select>
                <button class="danger" onclick="this.parentElement.remove()">âœ•</button>
            `;
            container.appendChild(div);
        }
        
        // å„²å­˜ç‡Ÿé¤Šç´ éœ€æ±‚
        function saveRequirements() {
            requirements = {};
            const inputs = document.querySelectorAll('[id^="req_name_"]');
            
            inputs.forEach((input) => {
                const id = input.id.split('_')[2];
                const name = document.getElementById(`req_name_${id}`).value.trim();
                const min = parseFloat(document.getElementById(`req_min_${id}`).value);
                const max = parseFloat(document.getElementById(`req_max_${id}`).value);
                const unit = document.getElementById(`req_unit_${id}`).value;
                
                if (name && !isNaN(min) && !isNaN(max)) {
                    requirements[name] = { min, max, unit };
                }
            });
            
            saveToLocalStorage();
            displayRequirements();
            updateProductNutrientSelects();
            alert('éœ€æ±‚å·²å„²å­˜ï¼');
        }
        
        // è¼‰å…¥ä¸¦é¡¯ç¤ºéœ€æ±‚
        function loadRequirements() {
            return Promise.resolve().then(() => {
                displayRequirements();
            });
        }
        
        function displayRequirements() {
            const container = document.getElementById('requirementsList');
            if (Object.keys(requirements).length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">å°šæœªè¨­å®šéœ€æ±‚</p>';
                return;
            }
            
            container.innerHTML = '<div class="grid">' + 
                Object.entries(requirements).map(([name, req]) => `
                    <div class="requirement-item">
                        <h4>${name}</h4>
                        <p>ç¯„åœï¼š${req.min} - ${req.max} ${req.unit}</p>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button onclick="editRequirement('${name}')" style="flex: 1; background: #28a745; font-size: 0.85em; padding: 8px;">ç·¨è¼¯</button>
                            <button class="danger" onclick="deleteRequirement('${name}')" style="flex: 1; font-size: 0.85em; padding: 8px;">åˆªé™¤</button>
                        </div>
                    </div>
                `).join('') + '</div>';
        }
        
        // ç·¨è¼¯éœ€æ±‚
        function editRequirement(name) {
            const req = requirements[name];
            if (!req) return;
            
            editingRequirementName = name;
            
            // æ¸…ç©ºè¼¸å…¥å€åŸŸä¸¦æ–°å¢ä¸€å€‹ç·¨è¼¯æ¬„ä½
            document.getElementById('requirementsInputs').innerHTML = '';
            requirementInputCount = 0;
            addRequirementInput();
            
            const id = requirementInputCount - 1;
            document.getElementById(`req_name_${id}`).value = name;
            document.getElementById(`req_min_${id}`).value = req.min;
            document.getElementById(`req_max_${id}`).value = req.max;
            document.getElementById(`req_unit_${id}`).value = req.unit;
            
            // ç¦æ­¢ä¿®æ”¹åç¨±ï¼ˆå› ç‚ºæœƒå½±éŸ¿å·²æœ‰ç”¢å“ï¼‰
            document.getElementById(`req_name_${id}`).disabled = true;
            document.getElementById(`req_name_${id}`).style.background = '#e9ecef';
            
            // æ”¹è®ŠæŒ‰éˆ•æ–‡å­—
            const saveBtn = document.querySelector('.section:nth-child(1) button[onclick="saveRequirements()"]');
            saveBtn.textContent = 'ğŸ’¾ æ›´æ–°éœ€æ±‚';
            saveBtn.style.background = '#28a745';
            
            // æ²å‹•åˆ°è¡¨å–®
            document.querySelector('.section:nth-child(1)').scrollIntoView({ behavior: 'smooth' });
        }
        
        // åˆªé™¤éœ€æ±‚
        function deleteRequirement(name) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ\næ³¨æ„ï¼šé€™æœƒå½±éŸ¿å·²æ–°å¢çš„ç”¢å“ã€‚`)) return;
            
            delete requirements[name];
            saveToLocalStorage();
            displayRequirements();
            updateProductNutrientSelects();
        }
        
        // æ¸…ç©ºéœ€æ±‚è¡¨å–®
        function clearRequirementForm() {
            document.getElementById('requirementsInputs').innerHTML = '';
            requirementInputCount = 0;
            addRequirementInput();
            editingRequirementName = null;
            
            const saveBtn = document.querySelector('.section:nth-child(1) button[onclick="saveRequirements()"]');
            saveBtn.textContent = 'ğŸ’¾ å„²å­˜éœ€æ±‚';
            saveBtn.style.background = '#667eea';
        }
        
        // æ–°å¢ç”¢å“ç‡Ÿé¤Šç´ è¼¸å…¥æ¬„ä½
        function addProductNutrient() {
            const container = document.getElementById('productNutrients');
            const id = productNutrientCount++;
            const div = document.createElement('div');
            div.className = 'product-nutrient-row';
            
            // å–å¾—å·²è¨­å®šçš„ç‡Ÿé¤Šç´ åç¨±ä½œç‚ºå»ºè­°é¸é …
            const nutrientOptions = Object.keys(requirements).length > 0 
                ? Object.keys(requirements).map(name => `<option value="${name}">`).join('')
                : '';
            
            div.innerHTML = `
                <input type="text" 
                       id="prod_nutrient_${id}" 
                       class="product-nutrient-input" 
                       list="nutrient-suggestions-${id}"
                       placeholder="ç‡Ÿé¤Šç´ åç¨±ï¼ˆä¾‹å¦‚ï¼šç¶­ä»–å‘½Cï¼‰"
                       style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 5px;">
                <datalist id="nutrient-suggestions-${id}">
                    ${nutrientOptions}
                </datalist>
                <input type="number" id="prod_amount_${id}" placeholder="å«é‡" step="0.01">
                <select id="prod_unit_${id}">
                    <option value="mg">mg</option>
                    <option value="Î¼g">Î¼g</option>
                    <option value="IU">IU</option>
                    <option value="g">g</option>
                </select>
                <button class="danger" onclick="this.parentElement.remove()">âœ•</button>
            `;
            container.appendChild(div);
        }
        
        // æ›´æ–°æ‰€æœ‰ç”¢å“ç‡Ÿé¤Šç´ å»ºè­°åˆ—è¡¨
        function updateProductNutrientSelects() {
            const inputs = document.querySelectorAll('.product-nutrient-input');
            
            // ç‚ºæ¯å€‹è¼¸å…¥æ¡†æ›´æ–° datalist
            inputs.forEach((input, index) => {
                const datalistId = input.getAttribute('list');
                const datalist = document.getElementById(datalistId);
                
                if (datalist) {
                    const nutrientOptions = Object.keys(requirements).length > 0 
                        ? Object.keys(requirements).map(name => `<option value="${name}">`).join('')
                        : '';
                    datalist.innerHTML = nutrientOptions;
                }
            });
        }
        
        // å„²å­˜ç”¢å“
        function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const totalPrice = parseFloat(document.getElementById('productTotalPrice').value);
            const totalServings = parseFloat(document.getElementById('productTotalServings').value);
            
            if (!name) {
                alert('è«‹å¡«å¯«ç”¢å“åç¨±');
                return;
            }
            
            if (isNaN(totalPrice) || totalPrice <= 0) {
                alert('è«‹å¡«å¯«æ­£ç¢ºçš„ç¸½åƒ¹æ ¼');
                return;
            }
            
            if (isNaN(totalServings) || totalServings <= 0) {
                alert('è«‹å¡«å¯«æ­£ç¢ºçš„ç¸½é¡†æ•¸');
                return;
            }
            
            const nutrients = {};
            const nutrientUnits = {};
            const inputs = document.querySelectorAll('[id^="prod_nutrient_"]');
            
            inputs.forEach((input) => {
                const id = input.id.split('_')[2];
                const nutrientInput = document.getElementById(`prod_nutrient_${id}`);
                const amountInput = document.getElementById(`prod_amount_${id}`);
                const unitSelect = document.getElementById(`prod_unit_${id}`);
                
                if (nutrientInput && amountInput && unitSelect) {
                    const nutrient = nutrientInput.value.trim();
                    const amount = parseFloat(amountInput.value);
                    const unit = unitSelect.value;
                    
                    if (nutrient && !isNaN(amount)) {
                        nutrients[nutrient] = amount;
                        nutrientUnits[nutrient] = unit;
                    }
                }
            });
            
            if (Object.keys(nutrients).length === 0) {
                alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹ç‡Ÿé¤Šç´ æˆåˆ†');
                return;
            }
            
            const pricePerServing = totalPrice / totalServings;
            const productId = editingProductId || Date.now().toString();
            const product = { 
                id: productId, 
                name, 
                totalPrice,
                totalServings,
                pricePerServing,
                nutrients,
                nutrientUnits
            };
            
            products[productId] = product;
            saveToLocalStorage();
            displayProducts();
            displayProductSelection();
            clearProductForm();
            alert(editingProductId ? 'ç”¢å“å·²æ›´æ–°ï¼' : 'ç”¢å“å·²æ–°å¢ï¼');
            editingProductId = null;
        }
        
        // æ¸…ç©ºç”¢å“è¡¨å–®
        function clearProductForm() {
            document.getElementById('productName').value = '';
            document.getElementById('productTotalPrice').value = '';
            document.getElementById('productTotalServings').value = '';
            document.getElementById('productNutrients').innerHTML = '';
            document.getElementById('pricePerServing').textContent = 'NT$ 0';
            productNutrientCount = 0;
            addProductNutrient();
        }
        
        // ç·¨è¼¯ç”¢å“
        function editProduct(productId) {
            const product = products[productId];
            if (!product) return;
            
            editingProductId = productId;
            document.getElementById('productName').value = product.name;
            document.getElementById('productTotalPrice').value = product.totalPrice;
            document.getElementById('productTotalServings').value = product.totalServings;
            updatePricePerServing();
            
            // æ¸…ç©ºä¸¦é‡æ–°å¡«å…¥ç‡Ÿé¤Šç´ 
            document.getElementById('productNutrients').innerHTML = '';
            productNutrientCount = 0;
            
            Object.entries(product.nutrients).forEach(([nutrient, amount]) => {
                addProductNutrient();
                const lastId = productNutrientCount - 1;
                document.getElementById(`prod_nutrient_${lastId}`).value = nutrient;
                document.getElementById(`prod_amount_${lastId}`).value = amount;
                // è¨­å®šå–®ä½
                if (product.nutrientUnits && product.nutrientUnits[nutrient]) {
                    document.getElementById(`prod_unit_${lastId}`).value = product.nutrientUnits[nutrient];
                } else if (requirements[nutrient]) {
                    document.getElementById(`prod_unit_${lastId}`).value = requirements[nutrient].unit;
                }
            });
            
            // æ²å‹•åˆ°è¡¨å–®
            document.querySelector('.section:nth-child(2)').scrollIntoView({ behavior: 'smooth' });
            
            // æ”¹è®ŠæŒ‰éˆ•æ–‡å­—
            const saveBtn = document.querySelector('.section:nth-child(2) button[onclick="saveProduct()"]');
            saveBtn.textContent = 'ğŸ’¾ æ›´æ–°ç”¢å“';
            saveBtn.style.background = '#28a745';
        }
        
        // å–æ¶ˆç·¨è¼¯
        function cancelEdit() {
            editingProductId = null;
            clearProductForm();
            const saveBtn = document.querySelector('.section:nth-child(2) button[onclick="saveProduct()"]');
            saveBtn.textContent = 'ğŸ’¾ æ–°å¢ç”¢å“';
            saveBtn.style.background = '#667eea';
        }
        
        // è¼‰å…¥ä¸¦é¡¯ç¤ºç”¢å“
        function loadProducts() {
            displayProducts();
            displayProductSelection();
        }
        
        function displayProducts() {
            const container = document.getElementById('productsList');
            if (Object.keys(products).length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">å°šæœªæ–°å¢ç”¢å“</p>';
                return;
            }
            
            container.innerHTML = '<div class="grid">' + 
                Object.values(products).map(p => {
                    // è¨ˆç®—å»ºè­°ç”¨é‡ï¼ˆåŸºæ–¼éœ€æ±‚ï¼‰
                    let suggestedServings = calculateSuggestedServings(p.nutrients);
                    let dailyCost = p.pricePerServing * suggestedServings;
                    let daysSupply = suggestedServings > 0 ? Math.floor(p.totalServings / suggestedServings) : 0;
                    
                    return `
                    <div class="product-item">
                        <h4>${p.name}</h4>
                        <p style="color: #6c757d;">ç¸½åƒ¹ NT$ ${p.totalPrice}ï¼ˆ${p.totalServings} é¡†ï¼‰</p>
                        <p style="color: #667eea; font-weight: bold;">æ¯é¡† NT$ ${p.pricePerServing.toFixed(2)}</p>
                        ${suggestedServings > 0 ? `
                            <p style="color: #28a745; font-weight: bold;">å»ºè­°æ¯æ—¥ ${suggestedServings} é¡† â†’ NT$ ${dailyCost.toFixed(2)}/æ—¥</p>
                            <p style="font-size: 0.9em; color: #6c757d;">å¯åƒç´„ ${daysSupply} å¤©</p>
                        ` : `
                            <p style="color: #6c757d; font-size: 0.9em;">ğŸ’¡ è¨­å®šéœ€æ±‚å¾Œå¯è¨ˆç®—å»ºè­°ç”¨é‡</p>
                        `}
                        <ul style="margin-top: 10px; font-size: 0.9em;">
                            ${Object.entries(p.nutrients).map(([n, a]) => {
                                const unit = (p.nutrientUnits && p.nutrientUnits[n]) || requirements[n]?.unit || 'mg';
                                return `<li>${n}: ${a} ${unit}/é¡†</li>`;
                            }).join('')}
                        </ul>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button onclick="editProduct('${p.id}')" style="flex: 1; background: #28a745;">ç·¨è¼¯</button>
                            <button class="danger" onclick="deleteProduct('${p.id}')" style="flex: 1;">åˆªé™¤</button>
                        </div>
                    </div>
                `;
                }).join('') + '</div>';
        }
        
        // è¨ˆç®—å»ºè­°ç”¨é‡ï¼ˆæ ¹æ“šéœ€æ±‚è¨ˆç®—æ¯å¤©æœ€å°‘è¦åƒå¹¾é¡†ï¼‰
        function calculateSuggestedServings(nutrients) {
            if (Object.keys(requirements).length === 0) return 0;
            
            let maxServings = 0;
            
            // æ‰¾å‡ºéœ€è¦æœ€å¤šé¡†æ•¸çš„ç‡Ÿé¤Šç´ 
            for (let nutrient in nutrients) {
                if (requirements[nutrient]) {
                    let perServing = nutrients[nutrient];
                    let required = requirements[nutrient].min;
                    let servingsNeeded = Math.ceil(required / perServing * 10) / 10; // å››æ¨äº”å…¥åˆ°0.1
                    maxServings = Math.max(maxServings, servingsNeeded);
                }
            }
            
            return maxServings;
        }
        
        function deleteProduct(productId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç”¢å“ï¼Ÿ')) return;
            
            delete products[productId];
            saveToLocalStorage();
            displayProducts();
            displayProductSelection();
        }
        
        // é¡¯ç¤ºç”¢å“é¸æ“‡
        function displayProductSelection() {
            const container = document.getElementById('productsSelection');
            if (Object.keys(products).length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">å°šæœªæ–°å¢ç”¢å“ï¼Œè«‹å…ˆæ–°å¢ç”¢å“</p>';
                return;
            }
            
            container.innerHTML = '<div class="grid">' + 
                Object.values(products).map(p => {
                    const suggestedServings = calculateSuggestedServings(p.nutrients);
                    const defaultServings = suggestedServings > 0 ? suggestedServings : 1;
                    
                    return `
                    <div class="product-item">
                        <input type="checkbox" class="product-checkbox" value="${p.id}" onchange="analyzeSelection()">
                        <h4>${p.name}</h4>
                        <p style="color: #667eea; font-weight: bold;">æ¯é¡† NT$ ${p.pricePerServing.toFixed(2)}</p>
                        <p style="font-size: 0.9em; color: #6c757d;">å…± ${p.totalServings} é¡†</p>
                        
                        <div style="margin: 10px 0; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <label style="font-size: 0.9em; margin-bottom: 5px;">æ¯æ—¥è¦åƒå¹¾é¡†ï¼Ÿ</label>
                            <input type="number" 
                                   id="serving_${p.id}" 
                                   class="serving-input" 
                                   value="${defaultServings}" 
                                   min="0.5" 
                                   step="0.5" 
                                   style="width: 100%; padding: 5px;"
                                   onchange="analyzeSelection()">
                            ${suggestedServings > 0 ? `<small style="color: #28a745;">ğŸ’¡ å»ºè­° ${suggestedServings} é¡†</small>` : ''}
                        </div>
                        
                        <ul style="margin-top: 10px; font-size: 0.9em;">
                            ${Object.entries(p.nutrients).map(([n, a]) => 
                                `<li>${n}: ${a} ${requirements[n]?.unit || ''}/é¡†</li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
                }).join('') + '</div>';
        }
        
        // åˆ†æé¸æ“‡çš„ç”¢å“çµ„åˆ
        function analyzeSelection() {
            const checkboxes = document.querySelectorAll('.product-checkbox:checked');
            const selected = Array.from(checkboxes).map(cb => {
                const productId = cb.value;
                const dailyServing = parseFloat(document.getElementById(`serving_${productId}`).value) || 1;
                return { productId, dailyServing };
            });
            
            if (selected.length === 0) {
                document.getElementById('currentAnalysis').innerHTML = '';
                currentAnalysisResult = null;
                return;
            }
            
            const data = analyzeLocal(selected);
            currentAnalysisResult = data;
            displayAnalysis(data);
        }
        
        // æœ¬åœ°åˆ†æå‡½æ•¸ï¼ˆä¸éœ€è¦å¾Œç«¯ï¼‰
        function analyzeLocal(selected) {
            if (Object.keys(requirements).length === 0) {
                alert('è«‹å…ˆè¨­å®šç‡Ÿé¤Šç´ éœ€æ±‚');
                return null;
            }
            
            // è¨ˆç®—ç¸½ç‡Ÿé¤Šç´ å«é‡ï¼ˆæ¯æ—¥ï¼‰
            let total_nutrients = {};
            let daily_cost = 0;
            let product_details = [];
            
            selected.forEach(item => {
                const productId = item.productId;
                const dailyServing = item.dailyServing;
                
                if (products[productId]) {
                    const product = products[productId];
                    
                    // è¨ˆç®—æ¯æ—¥æˆæœ¬
                    const product_daily_cost = product.pricePerServing * dailyServing;
                    daily_cost += product_daily_cost;
                    
                    // è¨ˆç®—å¯åƒå¤©æ•¸
                    const days_supply = dailyServing > 0 ? Math.floor(product.totalServings / dailyServing) : 0;
                    
                    product_details.push({
                        name: product.name,
                        pricePerServing: parseFloat(product.pricePerServing.toFixed(2)),
                        dailyCost: parseFloat(product_daily_cost.toFixed(2)),
                        dailyServing: dailyServing,
                        daysSupply: days_supply
                    });
                    
                    // è¨ˆç®—æ¯æ—¥ç‡Ÿé¤Šç´ ç¸½é‡
                    for (let nutrient in product.nutrients) {
                        const daily_amount = product.nutrients[nutrient] * dailyServing;
                        total_nutrients[nutrient] = (total_nutrients[nutrient] || 0) + daily_amount;
                    }
                }
            });
            
            // åˆ†æç¼ºå£å’Œéé‡
            const analysis = {
                sufficient: {},
                insufficient: {},
                excessive: {}
            };
            
            for (let nutrient in requirements) {
                const requirement = requirements[nutrient];
                const min_val = requirement.min;
                const max_val = requirement.max;
                const current = total_nutrients[nutrient] || 0;
                
                if (current < min_val) {
                    analysis.insufficient[nutrient] = {
                        current: parseFloat(current.toFixed(2)),
                        required: min_val,
                        gap: parseFloat((min_val - current).toFixed(2)),
                        unit: requirement.unit
                    };
                } else if (current > max_val) {
                    analysis.excessive[nutrient] = {
                        current: parseFloat(current.toFixed(2)),
                        max: max_val,
                        excess: parseFloat((current - max_val).toFixed(2)),
                        unit: requirement.unit
                    };
                } else {
                    analysis.sufficient[nutrient] = {
                        current: parseFloat(current.toFixed(2)),
                        min: min_val,
                        max: max_val,
                        unit: requirement.unit
                    };
                }
            }
            
            const completeness = Object.keys(requirements).length > 0 
                ? (Object.keys(analysis.sufficient).length / Object.keys(requirements).length * 100)
                : 0;
            
            return {
                products: product_details,
                daily_cost: parseFloat(daily_cost.toFixed(2)),
                total_nutrients: total_nutrients,
                analysis: analysis,
                completeness: completeness
            };
        }
        
        function displayAnalysis(data) {
            const container = document.getElementById('currentAnalysis');
            
            let html = '<div class="analysis-result">';
            html += '<h3>åˆ†æçµæœ</h3>';
            
            // å®Œæ•´åº¦
            html += `
                <div class="completeness-bar">
                    <div class="completeness-fill" style="width: ${data.completeness}%">
                        ${data.completeness.toFixed(1)}% å®Œæ•´
                    </div>
                </div>
            `;
            
            // æˆæœ¬è³‡è¨Š
            html += `
                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #667eea;">
                    <p style="margin: 0; font-size: 1.1em;">æ¯æ—¥æˆæœ¬ï¼š<span style="font-size: 1.5em; color: #667eea; font-weight: bold;">NT$ ${data.daily_cost}</span></p>
                </div>
            `;
            
            // é¸æ“‡çš„ç”¢å“è©³ç´°è³‡è¨Š
            html += '<div style="margin: 15px 0;"><strong>é¸æ“‡çš„ç”¢å“ï¼š</strong><ul style="margin-top: 10px;">';
            data.products.forEach(p => {
                html += `<li>${p.name} - æ¯æ—¥ ${p.dailyServing} é¡† (NT$ ${p.dailyCost}/æ—¥ï¼Œå¯åƒ ${p.daysSupply} å¤©)</li>`;
            });
            html += '</ul></div>';
            
            // å……è¶³çš„ç‡Ÿé¤Šç´ 
            if (Object.keys(data.analysis.sufficient).length > 0) {
                html += '<div class="status-box success"><h3>âœ… å·²æ»¿è¶³çš„ç‡Ÿé¤Šç´ </h3><ul class="nutrient-list">';
                Object.entries(data.analysis.sufficient).forEach(([name, info]) => {
                    html += `<li><strong>${name}</strong>: ${info.current} ${info.unit} (éœ€æ±‚: ${info.min}-${info.max})</li>`;
                });
                html += '</ul></div>';
            }
            
            // ä¸è¶³çš„ç‡Ÿé¤Šç´ 
            if (Object.keys(data.analysis.insufficient).length > 0) {
                html += '<div class="status-box warning"><h3>âš ï¸ ä¸è¶³çš„ç‡Ÿé¤Šç´ ï¼ˆéœ€é¡å¤–è£œå……ï¼‰</h3><ul class="nutrient-list">';
                Object.entries(data.analysis.insufficient).forEach(([name, info]) => {
                    html += `<li><strong>${name}</strong>: ç›®å‰ ${info.current} ${info.unit}ï¼Œé‚„å·® <span style="color: #dc3545; font-weight: bold;">${info.gap} ${info.unit}</span></li>`;
                });
                html += '</ul></div>';
            }
            
            // éé‡çš„ç‡Ÿé¤Šç´ 
            if (Object.keys(data.analysis.excessive).length > 0) {
                html += '<div class="status-box danger"><h3>âŒ éé‡çš„ç‡Ÿé¤Šç´ </h3><ul class="nutrient-list">';
                Object.entries(data.analysis.excessive).forEach(([name, info]) => {
                    html += `<li><strong>${name}</strong>: ${info.current} ${info.unit}ï¼Œè¶…é ${info.excess} ${info.unit}</li>`;
                });
                html += '</ul></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // å„²å­˜ç‚ºæ–¹æ¡ˆ
        function saveAsSolution() {
            if (!currentAnalysisResult) {
                alert('è«‹å…ˆåˆ†æç”¢å“çµ„åˆ');
                return;
            }
            
            const name = prompt('è«‹è¼¸å…¥æ–¹æ¡ˆåç¨±ï¼š');
            if (!name) return;
            
            const solution = {
                name,
                ...currentAnalysisResult
            };
            
            solution.id = solutions.length + 1;
            solution.created_at = new Date().toISOString();
            solutions.push(solution);
            saveToLocalStorage();
            loadSolutions();
            alert('æ–¹æ¡ˆå·²å„²å­˜ï¼');
        }
        
        // è¼‰å…¥ä¸¦é¡¯ç¤ºæ–¹æ¡ˆ
        function loadSolutions() {
            displaySolutions(solutions);
        }
        
        function displaySolutions(solutions) {
            const container = document.getElementById('solutionsList');
            
            if (solutions.length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">å°šæœªå„²å­˜ä»»ä½•æ–¹æ¡ˆ</p>';
                return;
            }
            
            let html = '<table class="solutions-table"><thead><tr>';
            html += '<th>æ–¹æ¡ˆåç¨±</th><th>ç”¢å“çµ„åˆ</th><th>æ¯æ—¥æˆæœ¬</th><th>å®Œæ•´åº¦</th><th>ä¸è¶³ç‡Ÿé¤Šç´ </th><th>éé‡ç‡Ÿé¤Šç´ </th><th>æ“ä½œ</th>';
            html += '</tr></thead><tbody>';
            
            solutions.forEach(s => {
                // è™•ç†ä¸è¶³çš„ç‡Ÿé¤Šç´ 
                const insufficientItems = Object.entries(s.analysis.insufficient || {}).map(([name, info]) => {
                    return `${name} (ç¼º ${info.gap} ${info.unit})`;
                });
                const insufficientDisplay = insufficientItems.length > 0 
                    ? `<span style="color: #856404;">${insufficientItems.join('<br>')}</span>` 
                    : '<span style="color: #28a745;">ç„¡</span>';
                
                // è™•ç†éé‡çš„ç‡Ÿé¤Šç´ 
                const excessiveItems = Object.entries(s.analysis.excessive || {}).map(([name, info]) => {
                    return `${name} (è¶…é ${info.excess} ${info.unit})`;
                });
                const excessiveDisplay = excessiveItems.length > 0 
                    ? `<span style="color: #dc3545;">${excessiveItems.join('<br>')}</span>` 
                    : '<span style="color: #28a745;">ç„¡</span>';
                
                html += `<tr>
                    <td><strong>${s.name}</strong></td>
                    <td style="font-size: 0.9em;">${s.products.map(p => p.name).join('ã€')}</td>
                    <td style="color: #667eea; font-weight: bold; white-space: nowrap;">NT$ ${s.daily_cost}/æ—¥</td>
                    <td style="white-space: nowrap;">${s.completeness.toFixed(1)}%</td>
                    <td style="font-size: 0.85em;">${insufficientDisplay}</td>
                    <td style="font-size: 0.85em;">${excessiveDisplay}</td>
                    <td><button class="danger" onclick="deleteSolution(${s.id})">åˆªé™¤</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // æ‰¾å‡ºæœ€ä¾¿å®œçš„æ¯æ—¥æˆæœ¬
            const minDailyCost = Math.min(...solutions.map(s => s.daily_cost));
            const bestSolution = solutions.find(s => s.daily_cost === minDailyCost);
            
            // æ‰¾å‡ºå®Œæ•´åº¦æœ€é«˜çš„æ–¹æ¡ˆ
            const maxCompleteness = Math.max(...solutions.map(s => s.completeness));
            const mostCompleteSolution = solutions.find(s => s.completeness === maxCompleteness);
            
            html += '<div style="margin-top: 15px; display: flex; gap: 20px; flex-wrap: wrap;">';
            html += `<p style="color: #667eea; font-weight: bold; margin: 0;">ğŸ’° æœ€ä½æ¯æ—¥æˆæœ¬ï¼šNT$ ${minDailyCost}/æ—¥ (${bestSolution.name})</p>`;
            html += `<p style="color: #28a745; font-weight: bold; margin: 0;">âœ… æœ€é«˜å®Œæ•´åº¦ï¼š${maxCompleteness.toFixed(1)}% (${mostCompleteSolution.name})</p>`;
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        function deleteSolution(solutionId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ–¹æ¡ˆï¼Ÿ')) return;
            
            solutions = solutions.filter(s => s.id !== solutionId);
            saveToLocalStorage();
            loadSolutions();
        }
        
        // åŒ¯å‡ºè³‡æ–™
        function exportData() {
            const data = {
                requirements,
                products,
                solutions,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `nutrition-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('è³‡æ–™å·²åŒ¯å‡ºï¼');
        }
        
        // åŒ¯å…¥è³‡æ–™
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('åŒ¯å…¥è³‡æ–™æœƒè¦†è“‹ç›®å‰çš„æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                        requirements = data.requirements || {};
                        products = data.products || {};
                        solutions = data.solutions || [];
                        
                        saveToLocalStorage();
                        
                        // é‡æ–°è¼‰å…¥é¡¯ç¤º
                        displayRequirements();
                        displayProducts();
                        displayProductSelection();
                        loadSolutions();
                        updateProductNutrientSelects();
                        
                        alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                        location.reload();
                    }
                } catch (error) {
                    alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            
            // æ¸…ç©º input ä»¥ä¾¿å¯ä»¥é‡è¤‡åŒ¯å…¥åŒä¸€æª”æ¡ˆ
            event.target.value = '';
        }
        
        // æ¸…ç©ºæ‰€æœ‰è³‡æ–™
        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\nå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ã€‚')) {
                if (confirm('å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦åˆªé™¤æ‰€æœ‰éœ€æ±‚ã€ç”¢å“å’Œæ–¹æ¡ˆå—ï¼Ÿ')) {
                    localStorage.removeItem('nutritionOptimizerData');
                    requirements = {};
                    products = {};
                    solutions = [];
                    
                    // é‡æ–°è¼‰å…¥é¡¯ç¤º
                    displayRequirements();
                    displayProducts();
                    displayProductSelection();
                    loadSolutions();
                    
                    alert('æ‰€æœ‰è³‡æ–™å·²æ¸…ç©ºï¼');
                    location.reload();
                }
            }
        }
        
        // é¡¯ç¤ºå–®ä½å°ç…§è¡¨
        function showUnitGuide() {
            const guideHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h2 style="margin-top: 0; color: #667eea;">ğŸ“– ç‡Ÿé¤Šç´ å–®ä½å°ç…§è¡¨</h2>
                        
                        <h3 style="color: #495057; margin-top: 20px;">ğŸ“ å–®ä½æ›ç®—</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <p style="margin: 5px 0;"><strong>1 å…¬å…‹ (g)</strong> = 1,000 æ¯«å…‹ (mg)</p>
                            <p style="margin: 5px 0;"><strong>1 æ¯«å…‹ (mg)</strong> = 1,000 å¾®å…‹ (Î¼g)</p>
                            <p style="margin: 5px 0; color: #dc3545;"><strong>âš ï¸ å¸¸è¦‹éŒ¯èª¤ï¼š</strong>ç¶­ä»–å‘½ B12 æ¨™ç¤º 100 Î¼gï¼Œèª¤å¯«æˆ 100 mgï¼ˆå·®äº† 1000 å€ï¼ï¼‰</p>
                        </div>
                        
                        <h3 style="color: #495057; margin-top: 20px;">ğŸ’Š å¸¸è¦‹ç‡Ÿé¤Šç´ å–®ä½</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 10px; text-align: left;">ç‡Ÿé¤Šç´ </th>
                                    <th style="padding: 10px; text-align: left;">å¸¸ç”¨å–®ä½</th>
                                    <th style="padding: 10px; text-align: left;">æ¯æ—¥å»ºè­°é‡åƒè€ƒ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 10px;">ç¶­ä»–å‘½ A</td>
                                    <td style="padding: 10px;"><strong>Î¼g æˆ– IU</strong></td>
                                    <td style="padding: 10px;">600-900 Î¼g</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 10px;">ç¶­ä»–å‘½ D</td>
                                    <td style="padding: 10px;"><strong>Î¼g æˆ– IU</strong></td>
                                    <td style="padding: 10px;">10-20 Î¼g (400-800 IU)</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 10px;">ç¶­ä»–å‘½ E</td>
                                    <td style="padding: 10px;"><strong>mg æˆ– IU</strong></td>
                                    <td style="padding: 10px;">12-15 mg</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 10px;">ç¶­ä»–å‘½ C</td>
                                    <td style="padding: 10px;"><strong>mg</strong></td>
                                    <td style="padding: 10px;">100-2000 mg</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 10px;">ç¶­ä»–å‘½ B1</td>
                                    <td style="padding: 10px;"><strong>mg</strong></td>
                                    <td style="padding: 10px;">1.2-100 mg</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 10px;">ç¶­ä»–å‘½ B2</td>
                                    <td style="padding: 10px;"><strong>mg</strong></td>
                                    <td style="padding: 10px;">1.3-100 mg</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 10px;">ç¶­ä»–å‘½ B6</td>
                                    <td style="padding: 10px;"><strong>mg</strong></td>
                                    <td style="padding: 10px;">1.5-100 mg</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 10px;">ç¶­ä»–å‘½ B9 (è‘‰é…¸)</td>
                                    <td style="padding: 10px;"><strong>Î¼g</strong></td>
                                    <td style="padding: 10px;">400-1000 Î¼g</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 10px;">ç¶­ä»–å‘½ B12</td>
                                    <td style="padding: 10px;"><strong>Î¼g</strong></td>
                                    <td style="padding: 10px;">2.4-100 Î¼g</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 10px;">éˆ£</td>
                                    <td style="padding: 10px;"><strong>mg</strong></td>
                                    <td style="padding: 10px;">1000-2500 mg</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 10px;">é‚</td>
                                    <td style="padding: 10px;"><strong>mg</strong></td>
                                    <td style="padding: 10px;">320-420 mg</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 10px;">é‹…</td>
                                    <td style="padding: 10px;"><strong>mg</strong></td>
                                    <td style="padding: 10px;">8-40 mg</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px;">éµ</td>
                                    <td style="padding: 10px;"><strong>mg</strong></td>
                                    <td style="padding: 10px;">8-45 mg</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ffc107;">
                            <p style="margin: 0; color: #856404;"><strong>ğŸ’¡ å°æŠ€å·§ï¼š</strong>ä¸ç¢ºå®šå–®ä½ï¼ŸæŸ¥çœ‹ç”¢å“åŒ…è£ä¸Šçš„ã€Œç‡Ÿé¤Šæ¨™ç¤ºã€ï¼Œé€šå¸¸æœƒæ¨™ç¤ºå–®ä½ã€‚</p>
                        </div>
                        
                        <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; margin-top: 20px; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                            é—œé–‰
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', guideHTML);
        }
    </script>
</body>
</html>
