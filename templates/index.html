<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡Ÿé¤Šç´ è£œå……æœ€ä½³åŒ–å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2em;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .section h2 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }
        
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.secondary:hover {
            background: #5a6268;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        button.danger:hover {
            background: #c82333;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .requirement-item,
        .product-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        
        .requirement-item h4,
        .product-item h4 {
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .product-item {
            position: relative;
        }
        
        .product-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .analysis-result {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .status-box {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .status-box.success {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        
        .status-box.warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        
        .status-box.danger {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }
        
        .status-box h3 {
            margin-bottom: 10px;
        }
        
        .nutrient-list {
            list-style: none;
        }
        
        .nutrient-list li {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.5);
            border-radius: 5px;
        }
        
        .solutions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .solutions-table th,
        .solutions-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .solutions-table th {
            background: #667eea;
            color: white;
            font-weight: 500;
        }
        
        .solutions-table tr:hover {
            background: #f8f9fa;
        }
        
        .cost-highlight {
            font-size: 1.5em;
            color: #667eea;
            font-weight: bold;
        }
        
        .completeness-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .completeness-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .flex-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .nutrient-input-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        
        .product-nutrient-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        
        #currentAnalysis {
            position: sticky;
            top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ¿ ç‡Ÿé¤Šç´ è£œå……æœ€ä½³åŒ–å·¥å…·</h1>
        
        <!-- æ­¥é©Ÿ1: è¨­å®šç‡Ÿé¤Šç´ éœ€æ±‚ -->
        <div class="section">
            <h2>æ­¥é©Ÿ 1ï¼šè¨­å®šç‡Ÿé¤Šç´ éœ€æ±‚ç¯„åœ</h2>
            <div id="requirementsInputs"></div>
            <button onclick="addRequirementInput()">â• æ–°å¢ç‡Ÿé¤Šç´ </button>
            <button onclick="saveRequirements()" style="margin-left: 10px;">ğŸ’¾ å„²å­˜éœ€æ±‚</button>
            <button onclick="clearRequirementForm()" class="secondary" style="margin-left: 10px;">ğŸ”„ æ¸…ç©ºè¡¨å–®</button>
            
            <div id="requirementsList" style="margin-top: 20px;"></div>
        </div>
        
        <!-- æ­¥é©Ÿ2: æ–°å¢ç”¢å“ -->
        <div class="section">
            <h2>æ­¥é©Ÿ 2ï¼šæ–°å¢ä¿å¥é£Ÿå“</h2>
            <div class="form-group">
                <label>ç”¢å“åç¨±</label>
                <input type="text" id="productName" placeholder="ä¾‹å¦‚ï¼šç”²æ¬¾ç¶œåˆç¶­ä»–å‘½">
            </div>
            
            <div class="grid" style="grid-template-columns: 1fr 1fr;">
                <div class="form-group">
                    <label>ç¸½åƒ¹æ ¼ï¼ˆå…ƒï¼‰<span style="color: #dc3545;">*</span></label>
                    <input type="number" id="productTotalPrice" placeholder="ä¾‹å¦‚ï¼š500" step="0.01">
                </div>
                <div class="form-group">
                    <label>ç¸½é¡†æ•¸/ç¸½ä»½æ•¸<span style="color: #dc3545;">*</span></label>
                    <input type="number" id="productTotalServings" placeholder="ä¾‹å¦‚ï¼š60" step="1">
                </div>
            </div>
            
            <div style="background: #e7f3ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                <p style="margin: 0; color: #004085;">æ¯é¡†æˆæœ¬ï¼š<span id="pricePerServing" style="font-weight: bold;">NT$ 0</span></p>
            </div>
            
            <div class="form-group">
                <label>ç‡Ÿé¤Šç´ æˆåˆ†ï¼ˆæ¯é¡†/æ¯ä»½å«é‡ï¼‰</label>
                <small style="color: #6c757d; display: block; margin-bottom: 10px;">ğŸ’¡ è«‹è¼¸å…¥ã€Œæ¯ä¸€é¡†ã€çš„ç‡Ÿé¤Šç´ å«é‡ï¼Œç³»çµ±æœƒæ ¹æ“šæ‚¨çš„éœ€æ±‚è‡ªå‹•è¨ˆç®—æ¯å¤©è¦åƒå¹¾é¡†</small>
                <div id="productNutrients"></div>
                <button onclick="addProductNutrient()">â• æ–°å¢æˆåˆ†</button>
            </div>
            <button onclick="saveProduct()">ğŸ’¾ æ–°å¢ç”¢å“</button>
            <button onclick="cancelEdit()" class="secondary" style="margin-left: 10px;">ğŸ”„ æ¸…ç©ºè¡¨å–®</button>
            
            <div id="productsList" style="margin-top: 20px;"></div>
        </div>
        
        <!-- æ­¥é©Ÿ3: åˆ†æçµ„åˆ -->
        <div class="section">
            <h2>æ­¥é©Ÿ 3ï¼šé¸æ“‡ç”¢å“çµ„åˆä¸¦åˆ†æ</h2>
            <div id="productsSelection"></div>
            <button onclick="analyzeSelection()" style="margin-top: 15px;">ğŸ” åˆ†æçµ„åˆ</button>
            <button onclick="saveAsSolution()" style="margin-left: 10px;">ğŸ’¾ å„²å­˜ç‚ºæ–¹æ¡ˆ</button>
            
            <div id="currentAnalysis"></div>
        </div>
        
        <!-- æ­¥é©Ÿ4: æ–¹æ¡ˆæ¯”è¼ƒ -->
        <div class="section">
            <h2>æ­¥é©Ÿ 4ï¼šæ–¹æ¡ˆæ¯”è¼ƒ</h2>
            <div id="solutionsList"></div>
        </div>
    </div>
    
    <script>
        let requirements = {};
        let products = {};
        let currentAnalysisResult = null;
        let requirementInputCount = 0;
        let productNutrientCount = 0;
        let editingProductId = null;
        let editingRequirementName = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadRequirements().then(() => {
                // ç­‰éœ€æ±‚è¼‰å…¥å®Œæˆå¾Œå†æ–°å¢ç”¢å“ç‡Ÿé¤Šç´ æ¬„ä½
                addProductNutrient();
            });
            loadProducts();
            loadSolutions();
            addRequirementInput();
            
            // ç›£è½åƒ¹æ ¼è®ŠåŒ–ä»¥æ›´æ–°æ¯é¡†æˆæœ¬
            document.getElementById('productTotalPrice').addEventListener('input', updatePricePerServing);
            document.getElementById('productTotalServings').addEventListener('input', updatePricePerServing);
        });
        
        // æ›´æ–°æ¯é¡†æˆæœ¬
        function updatePricePerServing() {
            const totalPrice = parseFloat(document.getElementById('productTotalPrice').value) || 0;
            const totalServings = parseFloat(document.getElementById('productTotalServings').value) || 0;
            const pricePerServing = totalServings > 0 ? totalPrice / totalServings : 0;
            document.getElementById('pricePerServing').textContent = 'NT$ ' + pricePerServing.toFixed(2);
        }
        
        // æ–°å¢ç‡Ÿé¤Šç´ éœ€æ±‚è¼¸å…¥æ¬„ä½
        function addRequirementInput() {
            const container = document.getElementById('requirementsInputs');
            const id = requirementInputCount++;
            const div = document.createElement('div');
            div.className = 'nutrient-input-row';
            div.innerHTML = `
                <input type="text" id="req_name_${id}" placeholder="ç‡Ÿé¤Šç´ åç¨±ï¼ˆä¾‹å¦‚ï¼šç¶­ä»–å‘½B6ï¼‰">
                <input type="number" id="req_min_${id}" placeholder="æœ€å°å€¼" step="0.01">
                <input type="number" id="req_max_${id}" placeholder="æœ€å¤§å€¼" step="0.01">
                <select id="req_unit_${id}">
                    <option value="mg">æ¯«å…‹(mg)</option>
                    <option value="Î¼g">å¾®å…‹(Î¼g)</option>
                    <option value="IU">åœ‹éš›å–®ä½(IU)</option>
                    <option value="g">å…¬å…‹(g)</option>
                </select>
                <button class="danger" onclick="this.parentElement.remove()">âœ•</button>
            `;
            container.appendChild(div);
        }
        
        // å„²å­˜ç‡Ÿé¤Šç´ éœ€æ±‚
        function saveRequirements() {
            requirements = {};
            const inputs = document.querySelectorAll('[id^="req_name_"]');
            
            inputs.forEach((input) => {
                const id = input.id.split('_')[2];
                const name = document.getElementById(`req_name_${id}`).value.trim();
                const min = parseFloat(document.getElementById(`req_min_${id}`).value);
                const max = parseFloat(document.getElementById(`req_max_${id}`).value);
                const unit = document.getElementById(`req_unit_${id}`).value;
                
                if (name && !isNaN(min) && !isNaN(max)) {
                    requirements[name] = { min, max, unit };
                }
            });
            
            fetch('/api/requirements', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requirements)
            })
            .then(() => {
                displayRequirements();
                // æ›´æ–°ç”¢å“ç‡Ÿé¤Šç´ é¸å–®
                updateProductNutrientSelects();
                alert('éœ€æ±‚å·²å„²å­˜ï¼');
            });
        }
        
        // è¼‰å…¥ä¸¦é¡¯ç¤ºéœ€æ±‚
        function loadRequirements() {
            return fetch('/api/requirements')
            .then(res => res.json())
            .then(data => {
                requirements = data;
                displayRequirements();
            });
        }
        
        function displayRequirements() {
            const container = document.getElementById('requirementsList');
            if (Object.keys(requirements).length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">å°šæœªè¨­å®šéœ€æ±‚</p>';
                return;
            }
            
            container.innerHTML = '<div class="grid">' + 
                Object.entries(requirements).map(([name, req]) => `
                    <div class="requirement-item">
                        <h4>${name}</h4>
                        <p>ç¯„åœï¼š${req.min} - ${req.max} ${req.unit}</p>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button onclick="editRequirement('${name}')" style="flex: 1; background: #28a745; font-size: 0.85em; padding: 8px;">ç·¨è¼¯</button>
                            <button class="danger" onclick="deleteRequirement('${name}')" style="flex: 1; font-size: 0.85em; padding: 8px;">åˆªé™¤</button>
                        </div>
                    </div>
                `).join('') + '</div>';
        }
        
        // ç·¨è¼¯éœ€æ±‚
        function editRequirement(name) {
            const req = requirements[name];
            if (!req) return;
            
            editingRequirementName = name;
            
            // æ¸…ç©ºè¼¸å…¥å€åŸŸä¸¦æ–°å¢ä¸€å€‹ç·¨è¼¯æ¬„ä½
            document.getElementById('requirementsInputs').innerHTML = '';
            requirementInputCount = 0;
            addRequirementInput();
            
            const id = requirementInputCount - 1;
            document.getElementById(`req_name_${id}`).value = name;
            document.getElementById(`req_min_${id}`).value = req.min;
            document.getElementById(`req_max_${id}`).value = req.max;
            document.getElementById(`req_unit_${id}`).value = req.unit;
            
            // ç¦æ­¢ä¿®æ”¹åç¨±ï¼ˆå› ç‚ºæœƒå½±éŸ¿å·²æœ‰ç”¢å“ï¼‰
            document.getElementById(`req_name_${id}`).disabled = true;
            document.getElementById(`req_name_${id}`).style.background = '#e9ecef';
            
            // æ”¹è®ŠæŒ‰éˆ•æ–‡å­—
            const saveBtn = document.querySelector('.section:nth-child(1) button[onclick="saveRequirements()"]');
            saveBtn.textContent = 'ğŸ’¾ æ›´æ–°éœ€æ±‚';
            saveBtn.style.background = '#28a745';
            
            // æ²å‹•åˆ°è¡¨å–®
            document.querySelector('.section:nth-child(1)').scrollIntoView({ behavior: 'smooth' });
        }
        
        // åˆªé™¤éœ€æ±‚
        function deleteRequirement(name) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ\næ³¨æ„ï¼šé€™æœƒå½±éŸ¿å·²æ–°å¢çš„ç”¢å“ã€‚`)) return;
            
            delete requirements[name];
            
            fetch('/api/requirements', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requirements)
            })
            .then(() => {
                displayRequirements();
                updateProductNutrientSelects();
            });
        }
        
        // æ¸…ç©ºéœ€æ±‚è¡¨å–®
        function clearRequirementForm() {
            document.getElementById('requirementsInputs').innerHTML = '';
            requirementInputCount = 0;
            addRequirementInput();
            editingRequirementName = null;
            
            const saveBtn = document.querySelector('.section:nth-child(1) button[onclick="saveRequirements()"]');
            saveBtn.textContent = 'ğŸ’¾ å„²å­˜éœ€æ±‚';
            saveBtn.style.background = '#667eea';
        }
        
        // æ–°å¢ç”¢å“ç‡Ÿé¤Šç´ è¼¸å…¥æ¬„ä½
        function addProductNutrient() {
            const container = document.getElementById('productNutrients');
            const id = productNutrientCount++;
            const div = document.createElement('div');
            div.className = 'product-nutrient-row';
            
            // å–å¾—å·²è¨­å®šçš„ç‡Ÿé¤Šç´ åç¨±ä½œç‚ºé¸é …
            const nutrientOptions = Object.keys(requirements).length > 0 
                ? Object.keys(requirements).map(name => `<option value="${name}">${name}</option>`).join('')
                : '<option value="">è«‹å…ˆè¨­å®šç‡Ÿé¤Šç´ éœ€æ±‚</option>';
            
            div.innerHTML = `
                <select id="prod_nutrient_${id}" class="product-nutrient-select">
                    <option value="">é¸æ“‡ç‡Ÿé¤Šç´ </option>
                    ${nutrientOptions}
                </select>
                <input type="number" id="prod_amount_${id}" placeholder="å«é‡" step="0.01">
                <button class="danger" onclick="this.parentElement.remove()">âœ•</button>
            `;
            container.appendChild(div);
        }
        
        // æ›´æ–°æ‰€æœ‰ç”¢å“ç‡Ÿé¤Šç´ é¸å–®
        function updateProductNutrientSelects() {
            const selects = document.querySelectorAll('.product-nutrient-select');
            
            // å–å¾—å·²è¨­å®šçš„ç‡Ÿé¤Šç´ åç¨±ä½œç‚ºé¸é …
            const nutrientOptions = Object.keys(requirements).length > 0 
                ? Object.keys(requirements).map(name => `<option value="${name}">${name}</option>`).join('')
                : '<option value="">è«‹å…ˆè¨­å®šç‡Ÿé¤Šç´ éœ€æ±‚</option>';
            
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = `
                    <option value="">é¸æ“‡ç‡Ÿé¤Šç´ </option>
                    ${nutrientOptions}
                `;
                // å˜—è©¦æ¢å¾©ä¹‹å‰é¸æ“‡çš„å€¼
                if (currentValue && requirements[currentValue]) {
                    select.value = currentValue;
                }
            });
        }
        
        // å„²å­˜ç”¢å“
        function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const totalPrice = parseFloat(document.getElementById('productTotalPrice').value);
            const totalServings = parseFloat(document.getElementById('productTotalServings').value);
            
            if (!name) {
                alert('è«‹å¡«å¯«ç”¢å“åç¨±');
                return;
            }
            
            if (isNaN(totalPrice) || totalPrice <= 0) {
                alert('è«‹å¡«å¯«æ­£ç¢ºçš„ç¸½åƒ¹æ ¼');
                return;
            }
            
            if (isNaN(totalServings) || totalServings <= 0) {
                alert('è«‹å¡«å¯«æ­£ç¢ºçš„ç¸½é¡†æ•¸');
                return;
            }
            
            const nutrients = {};
            const inputs = document.querySelectorAll('[id^="prod_nutrient_"]');
            
            inputs.forEach((input) => {
                const id = input.id.split('_')[2];
                const nutrient = document.getElementById(`prod_nutrient_${id}`).value;
                const amount = parseFloat(document.getElementById(`prod_amount_${id}`).value);
                
                if (nutrient && !isNaN(amount)) {
                    nutrients[nutrient] = amount;
                }
            });
            
            if (Object.keys(nutrients).length === 0) {
                alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹ç‡Ÿé¤Šç´ æˆåˆ†');
                return;
            }
            
            const pricePerServing = totalPrice / totalServings;
            const productId = editingProductId || Date.now().toString();
            const product = { 
                id: productId, 
                name, 
                totalPrice,
                totalServings,
                pricePerServing,
                nutrients 
            };
            
            fetch('/api/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(product)
            })
            .then(() => {
                products[productId] = product;
                displayProducts();
                displayProductSelection();
                clearProductForm();
                alert(editingProductId ? 'ç”¢å“å·²æ›´æ–°ï¼' : 'ç”¢å“å·²æ–°å¢ï¼');
                editingProductId = null;
            });
        }
        
        // æ¸…ç©ºç”¢å“è¡¨å–®
        function clearProductForm() {
            document.getElementById('productName').value = '';
            document.getElementById('productTotalPrice').value = '';
            document.getElementById('productTotalServings').value = '';
            document.getElementById('productNutrients').innerHTML = '';
            document.getElementById('pricePerServing').textContent = 'NT$ 0';
            productNutrientCount = 0;
            addProductNutrient();
        }
        
        // ç·¨è¼¯ç”¢å“
        function editProduct(productId) {
            const product = products[productId];
            if (!product) return;
            
            editingProductId = productId;
            document.getElementById('productName').value = product.name;
            document.getElementById('productTotalPrice').value = product.totalPrice;
            document.getElementById('productTotalServings').value = product.totalServings;
            updatePricePerServing();
            
            // æ¸…ç©ºä¸¦é‡æ–°å¡«å…¥ç‡Ÿé¤Šç´ 
            document.getElementById('productNutrients').innerHTML = '';
            productNutrientCount = 0;
            
            Object.entries(product.nutrients).forEach(([nutrient, amount]) => {
                addProductNutrient();
                const lastId = productNutrientCount - 1;
                document.getElementById(`prod_nutrient_${lastId}`).value = nutrient;
                document.getElementById(`prod_amount_${lastId}`).value = amount;
            });
            
            // æ²å‹•åˆ°è¡¨å–®
            document.querySelector('.section:nth-child(2)').scrollIntoView({ behavior: 'smooth' });
            
            // æ”¹è®ŠæŒ‰éˆ•æ–‡å­—
            const saveBtn = document.querySelector('.section:nth-child(2) button[onclick="saveProduct()"]');
            saveBtn.textContent = 'ğŸ’¾ æ›´æ–°ç”¢å“';
            saveBtn.style.background = '#28a745';
        }
        
        // å–æ¶ˆç·¨è¼¯
        function cancelEdit() {
            editingProductId = null;
            clearProductForm();
            const saveBtn = document.querySelector('.section:nth-child(2) button[onclick="saveProduct()"]');
            saveBtn.textContent = 'ğŸ’¾ æ–°å¢ç”¢å“';
            saveBtn.style.background = '#667eea';
        }
        
        // è¼‰å…¥ä¸¦é¡¯ç¤ºç”¢å“
        function loadProducts() {
            fetch('/api/products')
            .then(res => res.json())
            .then(data => {
                products = {};
                data.forEach(p => products[p.id] = p);
                displayProducts();
                displayProductSelection();
            });
        }
        
        function displayProducts() {
            const container = document.getElementById('productsList');
            if (Object.keys(products).length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">å°šæœªæ–°å¢ç”¢å“</p>';
                return;
            }
            
            container.innerHTML = '<div class="grid">' + 
                Object.values(products).map(p => {
                    // è¨ˆç®—å»ºè­°ç”¨é‡ï¼ˆåŸºæ–¼éœ€æ±‚ï¼‰
                    let suggestedServings = calculateSuggestedServings(p.nutrients);
                    let dailyCost = p.pricePerServing * suggestedServings;
                    let daysSupply = suggestedServings > 0 ? Math.floor(p.totalServings / suggestedServings) : 0;
                    
                    return `
                    <div class="product-item">
                        <h4>${p.name}</h4>
                        <p style="color: #6c757d;">ç¸½åƒ¹ NT$ ${p.totalPrice}ï¼ˆ${p.totalServings} é¡†ï¼‰</p>
                        <p style="color: #667eea; font-weight: bold;">æ¯é¡† NT$ ${p.pricePerServing.toFixed(2)}</p>
                        ${suggestedServings > 0 ? `
                            <p style="color: #28a745; font-weight: bold;">å»ºè­°æ¯æ—¥ ${suggestedServings} é¡† â†’ NT$ ${dailyCost.toFixed(2)}/æ—¥</p>
                            <p style="font-size: 0.9em; color: #6c757d;">å¯åƒç´„ ${daysSupply} å¤©</p>
                        ` : `
                            <p style="color: #6c757d; font-size: 0.9em;">ğŸ’¡ è¨­å®šéœ€æ±‚å¾Œå¯è¨ˆç®—å»ºè­°ç”¨é‡</p>
                        `}
                        <ul style="margin-top: 10px; font-size: 0.9em;">
                            ${Object.entries(p.nutrients).map(([n, a]) => 
                                `<li>${n}: ${a} ${requirements[n]?.unit || ''}/é¡†</li>`
                            ).join('')}
                        </ul>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button onclick="editProduct('${p.id}')" style="flex: 1; background: #28a745;">ç·¨è¼¯</button>
                            <button class="danger" onclick="deleteProduct('${p.id}')" style="flex: 1;">åˆªé™¤</button>
                        </div>
                    </div>
                `;
                }).join('') + '</div>';
        }
        
        // è¨ˆç®—å»ºè­°ç”¨é‡ï¼ˆæ ¹æ“šéœ€æ±‚è¨ˆç®—æ¯å¤©æœ€å°‘è¦åƒå¹¾é¡†ï¼‰
        function calculateSuggestedServings(nutrients) {
            if (Object.keys(requirements).length === 0) return 0;
            
            let maxServings = 0;
            
            // æ‰¾å‡ºéœ€è¦æœ€å¤šé¡†æ•¸çš„ç‡Ÿé¤Šç´ 
            for (let nutrient in nutrients) {
                if (requirements[nutrient]) {
                    let perServing = nutrients[nutrient];
                    let required = requirements[nutrient].min;
                    let servingsNeeded = Math.ceil(required / perServing * 10) / 10; // å››æ¨äº”å…¥åˆ°0.1
                    maxServings = Math.max(maxServings, servingsNeeded);
                }
            }
            
            return maxServings;
        }
        
        function deleteProduct(productId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç”¢å“ï¼Ÿ')) return;
            
            fetch(`/api/products/${productId}`, { method: 'DELETE' })
            .then(() => {
                delete products[productId];
                displayProducts();
                displayProductSelection();
            });
        }
        
        // é¡¯ç¤ºç”¢å“é¸æ“‡
        function displayProductSelection() {
            const container = document.getElementById('productsSelection');
            if (Object.keys(products).length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">å°šæœªæ–°å¢ç”¢å“ï¼Œè«‹å…ˆæ–°å¢ç”¢å“</p>';
                return;
            }
            
            container.innerHTML = '<div class="grid">' + 
                Object.values(products).map(p => {
                    const suggestedServings = calculateSuggestedServings(p.nutrients);
                    const defaultServings = suggestedServings > 0 ? suggestedServings : 1;
                    
                    return `
                    <div class="product-item">
                        <input type="checkbox" class="product-checkbox" value="${p.id}" onchange="analyzeSelection()">
                        <h4>${p.name}</h4>
                        <p style="color: #667eea; font-weight: bold;">æ¯é¡† NT$ ${p.pricePerServing.toFixed(2)}</p>
                        <p style="font-size: 0.9em; color: #6c757d;">å…± ${p.totalServings} é¡†</p>
                        
                        <div style="margin: 10px 0; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <label style="font-size: 0.9em; margin-bottom: 5px;">æ¯æ—¥è¦åƒå¹¾é¡†ï¼Ÿ</label>
                            <input type="number" 
                                   id="serving_${p.id}" 
                                   class="serving-input" 
                                   value="${defaultServings}" 
                                   min="0.5" 
                                   step="0.5" 
                                   style="width: 100%; padding: 5px;"
                                   onchange="analyzeSelection()">
                            ${suggestedServings > 0 ? `<small style="color: #28a745;">ğŸ’¡ å»ºè­° ${suggestedServings} é¡†</small>` : ''}
                        </div>
                        
                        <ul style="margin-top: 10px; font-size: 0.9em;">
                            ${Object.entries(p.nutrients).map(([n, a]) => 
                                `<li>${n}: ${a} ${requirements[n]?.unit || ''}/é¡†</li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
                }).join('') + '</div>';
        }
        
        // åˆ†æé¸æ“‡çš„ç”¢å“çµ„åˆ
        function analyzeSelection() {
            const checkboxes = document.querySelectorAll('.product-checkbox:checked');
            const selected = Array.from(checkboxes).map(cb => {
                const productId = cb.value;
                const dailyServing = parseFloat(document.getElementById(`serving_${productId}`).value) || 1;
                return { productId, dailyServing };
            });
            
            if (selected.length === 0) {
                document.getElementById('currentAnalysis').innerHTML = '';
                currentAnalysisResult = null;
                return;
            }
            
            fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ products: selected })
            })
            .then(res => res.json())
            .then(data => {
                currentAnalysisResult = data;
                displayAnalysis(data);
            });
        }
        
        function displayAnalysis(data) {
            const container = document.getElementById('currentAnalysis');
            
            let html = '<div class="analysis-result">';
            html += '<h3>åˆ†æçµæœ</h3>';
            
            // å®Œæ•´åº¦
            html += `
                <div class="completeness-bar">
                    <div class="completeness-fill" style="width: ${data.completeness}%">
                        ${data.completeness.toFixed(1)}% å®Œæ•´
                    </div>
                </div>
            `;
            
            // æˆæœ¬è³‡è¨Š
            html += `
                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #667eea;">
                    <p style="margin: 0; font-size: 1.1em;">æ¯æ—¥æˆæœ¬ï¼š<span style="font-size: 1.5em; color: #667eea; font-weight: bold;">NT$ ${data.daily_cost}</span></p>
                </div>
            `;
            
            // é¸æ“‡çš„ç”¢å“è©³ç´°è³‡è¨Š
            html += '<div style="margin: 15px 0;"><strong>é¸æ“‡çš„ç”¢å“ï¼š</strong><ul style="margin-top: 10px;">';
            data.products.forEach(p => {
                html += `<li>${p.name} - æ¯æ—¥ ${p.dailyServing} é¡† (NT$ ${p.dailyCost}/æ—¥ï¼Œå¯åƒ ${p.daysSupply} å¤©)</li>`;
            });
            html += '</ul></div>';
            
            // å……è¶³çš„ç‡Ÿé¤Šç´ 
            if (Object.keys(data.analysis.sufficient).length > 0) {
                html += '<div class="status-box success"><h3>âœ… å·²æ»¿è¶³çš„ç‡Ÿé¤Šç´ </h3><ul class="nutrient-list">';
                Object.entries(data.analysis.sufficient).forEach(([name, info]) => {
                    html += `<li><strong>${name}</strong>: ${info.current} ${info.unit} (éœ€æ±‚: ${info.min}-${info.max})</li>`;
                });
                html += '</ul></div>';
            }
            
            // ä¸è¶³çš„ç‡Ÿé¤Šç´ 
            if (Object.keys(data.analysis.insufficient).length > 0) {
                html += '<div class="status-box warning"><h3>âš ï¸ ä¸è¶³çš„ç‡Ÿé¤Šç´ ï¼ˆéœ€é¡å¤–è£œå……ï¼‰</h3><ul class="nutrient-list">';
                Object.entries(data.analysis.insufficient).forEach(([name, info]) => {
                    html += `<li><strong>${name}</strong>: ç›®å‰ ${info.current} ${info.unit}ï¼Œé‚„å·® <span style="color: #dc3545; font-weight: bold;">${info.gap} ${info.unit}</span></li>`;
                });
                html += '</ul></div>';
            }
            
            // éé‡çš„ç‡Ÿé¤Šç´ 
            if (Object.keys(data.analysis.excessive).length > 0) {
                html += '<div class="status-box danger"><h3>âŒ éé‡çš„ç‡Ÿé¤Šç´ </h3><ul class="nutrient-list">';
                Object.entries(data.analysis.excessive).forEach(([name, info]) => {
                    html += `<li><strong>${name}</strong>: ${info.current} ${info.unit}ï¼Œè¶…é ${info.excess} ${info.unit}</li>`;
                });
                html += '</ul></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // å„²å­˜ç‚ºæ–¹æ¡ˆ
        function saveAsSolution() {
            if (!currentAnalysisResult) {
                alert('è«‹å…ˆåˆ†æç”¢å“çµ„åˆ');
                return;
            }
            
            const name = prompt('è«‹è¼¸å…¥æ–¹æ¡ˆåç¨±ï¼š');
            if (!name) return;
            
            const solution = {
                name,
                ...currentAnalysisResult
            };
            
            fetch('/api/solutions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(solution)
            })
            .then(() => {
                loadSolutions();
                alert('æ–¹æ¡ˆå·²å„²å­˜ï¼');
            });
        }
        
        // è¼‰å…¥ä¸¦é¡¯ç¤ºæ–¹æ¡ˆ
        function loadSolutions() {
            fetch('/api/solutions')
            .then(res => res.json())
            .then(data => {
                displaySolutions(data);
            });
        }
        
        function displaySolutions(solutions) {
            const container = document.getElementById('solutionsList');
            
            if (solutions.length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">å°šæœªå„²å­˜ä»»ä½•æ–¹æ¡ˆ</p>';
                return;
            }
            
            let html = '<table class="solutions-table"><thead><tr>';
            html += '<th>æ–¹æ¡ˆåç¨±</th><th>ç”¢å“çµ„åˆ</th><th>æ¯æ—¥æˆæœ¬</th><th>å®Œæ•´åº¦</th><th>ä¸è¶³é …ç›®</th><th>æ“ä½œ</th>';
            html += '</tr></thead><tbody>';
            
            solutions.forEach(s => {
                const insufficientCount = Object.keys(s.analysis.insufficient).length;
                const insufficientList = Object.keys(s.analysis.insufficient).join('ã€');
                
                html += `<tr>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.products.map(p => p.name).join('ã€')}</td>
                    <td style="color: #667eea; font-weight: bold;">NT$ ${s.daily_cost}/æ—¥</td>
                    <td>${s.completeness.toFixed(1)}%</td>
                    <td>${insufficientCount > 0 ? insufficientList : 'ç„¡'}</td>
                    <td><button class="danger" onclick="deleteSolution(${s.id})">åˆªé™¤</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // æ‰¾å‡ºæœ€ä¾¿å®œçš„æ¯æ—¥æˆæœ¬
            const minDailyCost = Math.min(...solutions.map(s => s.daily_cost));
            const bestSolution = solutions.find(s => s.daily_cost === minDailyCost);
            html += `<p style="margin-top: 15px; color: #667eea; font-weight: bold;">ğŸ’¡ æœ€ä½æ¯æ—¥æˆæœ¬ï¼šNT$ ${minDailyCost}/æ—¥ (${bestSolution.name})</p>`;
            
            container.innerHTML = html;
        }
        
        function deleteSolution(solutionId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ–¹æ¡ˆï¼Ÿ')) return;
            
            fetch(`/api/solutions/${solutionId}`, { method: 'DELETE' })
            .then(() => loadSolutions());
        }
    </script>
</body>
</html>
